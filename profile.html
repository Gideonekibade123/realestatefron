<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Profile</title>
</head>
<body>

<h2>My Profile</h2>

<form id="profileForm">
    <input type="text" id="username" placeholder="Username" required><br><br>
    <input type="email" id="email" placeholder="Email" required><br><br>
    <button type="submit">Update Profile</button>
</form>

<br>
<button id="logoutBtn">Logout</button>
<p id="message"></p>

<script>
const API_BASE = "https://backendlastproject.onrender.com/api/auth";

// ---------------- JWT helpers ----------------
function getAccessToken() { return localStorage.getItem("access_token"); }
function getRefreshToken() { return localStorage.getItem("refresh_token"); }
function clearTokens() { localStorage.removeItem("access_token"); localStorage.removeItem("refresh_token"); }

// ---------------- Auth fetch ----------------
async function authFetch(url, options = {}) {
    let access = getAccessToken();
    if (!access) {
        clearTokens();
        window.location.href = "login.html";
        return;
    }

    options.headers = { ...(options.headers || {}), Authorization: `Bearer ${access}` };
    let res = await fetch(url, options);

    // If access token expired, try refreshing
    if (res.status === 401) {
        const refresh = getRefreshToken();
        if (!refresh) {
            clearTokens();
            window.location.href = "login.html";
            return;
        }

        const refreshRes = await fetch("http://127.0.0.1:8000/api/token/refresh/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ refresh })
        });

        if (!refreshRes.ok) {
            clearTokens();
            window.location.href = "login.html";
            return;
        }

        const refreshData = await refreshRes.json();
        localStorage.setItem("access_token", refreshData.access);
        options.headers.Authorization = `Bearer ${refreshData.access}`;
        res = await fetch(url, options); // retry original request
    }

    return res;
}

// ---------------- Load profile ----------------
async function loadProfile() {
    try {
        const res = await authFetch(`${API_BASE}/profile/`);
        if (!res.ok) throw new Error("Failed to load profile");

        const data = await res.json();
        usernameInput.value = data.username;
        emailInput.value = data.email;

    } catch (err) {
        message.textContent = "Error loading profile. Please login again.";
        clearTokens();
        window.location.href = "login.html";
        console.error(err);
    }
}

// ---------------- Update profile ----------------
profileForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    try {
        const res = await authFetch(`${API_BASE}/profile/`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                username: usernameInput.value,
                email: emailInput.value
            })
        });

        const data = await res.json();
        if (!res.ok) {
            message.textContent = JSON.stringify(data);
            return;
        }

        message.textContent = "Profile updated successfully âœ… Redirecting...";
        setTimeout(() => window.location.href = "home.html", 1000);

    } catch (err) {
        message.textContent = "Error updating profile";
        console.error(err);
    }
});

// ---------------- Logout ----------------
logoutBtn.addEventListener("click", () => {
    clearTokens();
    window.location.href = "login.html";
});

const usernameInput = document.getElementById("username");
const emailInput = document.getElementById("email");
const message = document.getElementById("message");
const logoutBtn = document.getElementById("logoutBtn");
const profileForm = document.getElementById("profileForm");

loadProfile();
</script>

</body>
</html>

