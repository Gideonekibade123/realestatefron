<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard - Real Estate Platform</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
    .listing-images {
        display: flex;
        overflow-x: auto;
        gap: 6px;
        margin-bottom: 10px;
    }
    .listing-images img {
        width: 120px;
        height: 90px;
        object-fit: cover;
        border-radius: 5px;
    }
    .modal-gallery {
        display: flex;
        overflow-x: auto;
        gap: 10px;
    }
    .modal-gallery img {
        height: 250px;
        border-radius: 6px;
        object-fit: cover;
    }
    .bold-title { font-weight: bold; }
    #imagePreviews img {
        width: 80px;
        height: 60px;
        object-fit: cover;
        margin-right: 5px;
        margin-bottom: 5px;
        border-radius: 4px;
    }
</style>
</head>

<body class="bg-light">
<div class="container my-4">

    <!-- HEADER -->
    <div class="card mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h4>Welcome, <span id="displayUsername">Guest</span> ðŸ‘‹</h4>
                <small class="text-muted">Upload or Buy Listings</small>
            </div>
            <div>
                <button id="loginBtn" class="btn btn-outline-success btn-sm">Login</button>
                <button id="registerBtn" class="btn btn-outline-primary btn-sm">Register</button>
                <button id="logoutBtn" class="btn btn-outline-danger btn-sm" style="display:none;">Logout</button>
            </div>
        </div>
    </div>

    <!-- UPLOAD FORM -->
    <div class="card mb-4" id="uploadCard" style="display:none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Upload New Listing</h5>
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#uploadListingDropdown">
                Toggle
            </button>
        </div>

        <div id="uploadListingDropdown" class="collapse">
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="text" name="title" class="form-control mb-2" placeholder="Property Title" required>
                    <textarea name="description" class="form-control mb-2" placeholder="Description" required></textarea>
                    <input type="text" name="location" class="form-control mb-2" placeholder="Location" required>
                    <input type="number" name="price" class="form-control mb-2" placeholder="Price" required>
                    <input type="text" name="phone" class="form-control mb-2" placeholder="Phone">
                    <select name="category" class="form-control mb-2" required>
                        <option value="">Select Category</option>
                        <option value="sale">For Sale</option>
                        <option value="rent">For Rent</option>
                        <option value="buy">Buy</option>
                        <option value="lease">Lease</option>
                    </select>
                    <input type="file" name="images" multiple class="form-control mb-2">
                    <button class="btn btn-success w-100">Upload Listing</button>
                    <p id="uploadResponse" class="mt-2"></p>
                </form>
            </div>
        </div>
    </div>

    <!-- LISTINGS CONTAINER -->
    <div id="listingsContainer" class="row g-4"></div>
</div>

<!-- MODAL -->
<div class="modal fade" id="buyModal" tabindex="-1">
<div class="modal-dialog modal-xl modal-dialog-centered">
<div class="modal-content">

<div class="modal-header">
    <h5 id="modalTitle" class="bold-title"></h5>
    <button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
    <div id="modalGallery" class="modal-gallery mb-3"></div>
    <p id="modalLocation"></p>
    <p id="modalPrice"></p>
    <p id="modalSeller"></p>

    <div class="card mt-4">
        <div class="card-body">
            <h5>Send Enquiry</h5>
            <form id="listingMessageForm">
                <textarea id="msgContent" class="form-control mb-2" required></textarea>
                <button type="submit" class="btn btn-primary w-100">Send Message</button>
            </form>
            <p id="listingMessageResponse" class="mt-2"></p>
        </div>
    </div>
</div>

<div class="modal-footer">
    <button id="buyNowBtn" class="btn btn-success">Buy Now</button>
    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
</div>

</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE = "https://backendlastproject.onrender.com/api";
let currentUser = null;
let currentEmail = null;
let selectedListing = null;

/* AUTH FETCH */
async function authFetch(url, options = {}) {
    const token = localStorage.getItem("access_token");
    options.headers = options.headers || {};
    if (!(options.body instanceof FormData)) {
        options.headers["Content-Type"] = "application/json";
    }
    if (token) options.headers["Authorization"] = `Bearer ${token}`;
    return fetch(url, options);
}

/* LOAD PROFILE */
async function loadProfile() {
    try {
        const res = await authFetch(`${API_BASE}/auth/profile/`);
        if (!res.ok) throw "unauth";
        const data = await res.json();
        currentUser = data.username;
        currentEmail = data.email;

        document.getElementById("displayUsername").textContent = currentUser;
        document.getElementById("uploadCard").style.display = "block";
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("registerBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";
    } catch {
        currentUser = null;
        currentEmail = null;
    }
    loadListings();
}

/* LOAD LISTINGS */
async function loadListings() {
    try {
        const res = await fetch(`${API_BASE}/listings/`);
        const listings = await res.json();
        const container = document.getElementById("listingsContainer");
        container.innerHTML = "";

        listings.forEach(l => {
            const col = document.createElement("div");
            col.className = "col-md-4";
            col.innerHTML = `
                <div class="card h-100">
                    <img src="https://backendlastproject.onrender.com/${l.images?.[0]?.image || ''}" class="card-img-top">
                    <div class="card-body">
                        <h5>${l.title}</h5>
                        <p>${l.location}</p>
                        <strong>â‚¦${l.price}</strong>
                    </div>
                </div>
            `;
            col.onclick = () => openModal(l);
            container.appendChild(col);
        });
    } catch (err) {
        console.error("Failed to load listings:", err);
    }
}

/* OPEN MODAL */
function openModal(l) {
    selectedListing = l;
    document.getElementById("modalTitle").textContent = l.title;
    document.getElementById("modalLocation").textContent = l.location;
    document.getElementById("modalPrice").textContent = `â‚¦${l.price}`;
    document.getElementById("modalSeller").textContent = l.seller_name;

    const gallery = document.getElementById("modalGallery");
    gallery.innerHTML = "";
    l.images.forEach(img => {
        const i = document.createElement("img");
        i.src = `https://backendlastproject.onrender.com/${img.image}`;
        gallery.appendChild(i);
    });

    new bootstrap.Modal(document.getElementById("buyModal")).show();
}

/* SEND ENQUIRY */
document.getElementById("listingMessageForm").addEventListener("submit", async e => {
    e.preventDefault();
    const msgContent = document.getElementById("msgContent");
    if (!currentUser) {
        document.getElementById("listingMessageResponse").textContent = "Please login first âŒ";
        return;
    }
    try {
        const res = await authFetch(`${API_BASE}/enquiries/`, {
            method: "POST",
            body: JSON.stringify({
                listing: selectedListing.id,
                message: msgContent.value.trim()
            })
        });

        if (res.ok) {
            document.getElementById("listingMessageResponse").textContent = "Message sent âœ…";
            msgContent.value = "";
        } else {
            const text = await res.text();
            console.error("Enquiry failed:", text);
            document.getElementById("listingMessageResponse").textContent = "Message failed âŒ";
        }
    } catch (err) {
        document.getElementById("listingMessageResponse").textContent = "Message failed âŒ";
        console.error(err);
    }
});

/* UPLOAD */
document.getElementById("uploadForm").addEventListener("submit", async e => {
    e.preventDefault();
    try {
        const res = await authFetch(`${API_BASE}/listings/`, {
            method: "POST",
            body: new FormData(e.target)
        });
        document.getElementById("uploadResponse").textContent =
            res.ok ? "Uploaded âœ…" : "Upload failed âŒ";
        if (res.ok) {
            e.target.reset();
            loadListings();
        }
    } catch (err) {
        document.getElementById("uploadResponse").textContent = "Upload failed âŒ";
        console.error(err);
    }
});

/* BUY NOW PAYMENT */
document.getElementById("buyNowBtn").addEventListener("click", async () => {
    if (!currentUser) {
        alert("Please login first!");
        return;
    }
    if (!selectedListing) {
        alert("No listing selected!");
        return;
    }
    try {
        const res = await authFetch(`${API_BASE}/payments/paystack/init/`, {
            method: "POST",
            body: JSON.stringify({ amount: selectedListing.price * 100 }) // amount in kobo
        });

        let data;
        try { data = await res.json(); }
        catch {
            console.error(await res.text());
            alert("Payment server error âŒ");
            return;
        }

        if (data.authorization_url) {
            window.location.href = data.authorization_url;
        } else {
            alert("Payment initiation failed âŒ");
            console.error(data);
        }
    } catch (err) {
        alert("Payment initiation failed âŒ");
        console.error(err);
    }
});

/* BUTTONS */
document.getElementById("loginBtn").onclick = () => location.href = "login.html";
document.getElementById("registerBtn").onclick = () => location.href = "register.html";
document.getElementById("logoutBtn").onclick = () => {
    localStorage.clear();
    location.href = "login.html";
};

/* INITIALIZE */
loadProfile();
</script>
</body>
</html>

