<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard - Real Estate Platform</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
.listing-images { display:flex; overflow-x:auto; gap:6px; margin-bottom:10px; }
.listing-images img { width:120px; height:90px; object-fit:cover; border-radius:5px; }
.modal-gallery { display:flex; overflow-x:auto; gap:10px; }
.modal-gallery img { height:250px; border-radius:6px; object-fit:cover; }
.bold-title { font-weight:bold; }
</style>
</head>

<body class="bg-light">
<div class="container my-4">

<div class="card mb-4">
<div class="card-body d-flex justify-content-between align-items-center">
<div>
<h4>Welcome, <span id="displayUsername">Guest</span> ðŸ‘‹</h4>
<small class="text-muted">Upload or Buy Listings</small>
</div>
<div>
<button id="loginBtn" class="btn btn-outline-success btn-sm">Login</button>
<button id="registerBtn" class="btn btn-outline-primary btn-sm">Register</button>
<button id="logoutBtn" class="btn btn-outline-danger btn-sm" style="display:none;">Logout</button>
</div>
</div>
</div>

<div class="card mb-4" id="uploadCard" style="display:none;">
<div class="card-body">
<form id="uploadForm" enctype="multipart/form-data">
<input name="title" class="form-control mb-2" placeholder="Title" required>
<textarea name="description" class="form-control mb-2" required></textarea>
<input name="location" class="form-control mb-2" required>
<input name="price" type="number" class="form-control mb-2" required>
<input name="phone" class="form-control mb-2">
<select name="category" class="form-control mb-2" required>
<option value="">Category</option>
<option value="sale">Sale</option>
<option value="rent">Rent</option>
</select>
<input type="file" name="images" multiple class="form-control mb-2">
<button class="btn btn-success w-100">Upload</button>
<p id="uploadResponse"></p>
</form>
</div>
</div>

<div id="listingsContainer" class="row g-4"></div>
</div>

<div class="modal fade" id="buyModal">
<div class="modal-dialog modal-xl modal-dialog-centered">
<div class="modal-content">

<div class="modal-header">
<h5 id="modalTitle"></h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
<div id="modalGallery" class="modal-gallery mb-3"></div>
<p id="modalLocation"></p>
<p id="modalPrice"></p>
<p id="modalSeller"></p>
</div>

<div class="modal-footer">
<button id="buyNowBtn" class="btn btn-success">Buy Now</button>
<button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
</div>

</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE = "https://backendlastproject.onrender.com/api";
let currentUser=null, currentEmail=null, selectedListing=null;

/* SAFE AUTH FETCH */
async function authFetch(url, options={}) {
    const token = localStorage.getItem("access_token");
    options.headers = options.headers || {};
    if (!(options.body instanceof FormData)) {
        options.headers["Content-Type"] = "application/json";
    }
    if (token) options.headers["Authorization"] = `Bearer ${token}`;
    return fetch(url, options);
}

/* PROFILE */
async function loadProfile() {
    try {
        const res = await authFetch(`${API_BASE}/auth/profile/`);
        if (!res.ok) throw "";
        const data = await res.json();
        currentUser=data.username;
        currentEmail=data.email;
        displayUsername.textContent=currentUser;
        uploadCard.style.display="block";
        loginBtn.style.display=registerBtn.style.display="none";
        logoutBtn.style.display="inline-block";
    } catch {}
    loadListings();
}

/* LISTINGS */
async function loadListings() {
    const res = await fetch(`${API_BASE}/listings/`);
    const listings = await res.json();
    listingsContainer.innerHTML="";
    listings.forEach(l=>{
        const d=document.createElement("div");
        d.className="col-md-4";
        d.innerHTML=`
        <div class="card h-100">
        <img src="https://backendlastproject.onrender.com/${l.images?.[0]?.image||""}">
        <div class="card-body">
        <h5>${l.title}</h5>
        <strong>â‚¦${l.price}</strong>
        </div></div>`;
        d.onclick=()=>openModal(l);
        listingsContainer.appendChild(d);
    });
}

/* MODAL */
function openModal(l){
    selectedListing=l;
    modalTitle.textContent=l.title;
    modalLocation.textContent=l.location;
    modalPrice.textContent=`â‚¦${l.price}`;
    modalSeller.textContent=l.seller_name;
    modalGallery.innerHTML="";
    l.images.forEach(i=>{
        const img=document.createElement("img");
        img.src=`https://backendlastproject.onrender.com/${i.image}`;
        modalGallery.appendChild(img);
    });
    new bootstrap.Modal(buyModal).show();
}

/* UPLOAD */
uploadForm.onsubmit=async e=>{
    e.preventDefault();
    const res=await authFetch(`${API_BASE}/listings/`,{
        method:"POST",
        body:new FormData(e.target)
    });
    uploadResponse.textContent=res.ok?"Uploaded âœ…":"Failed âŒ";
    if(res.ok){e.target.reset();loadListings();}
};

/* PAYSTACK */
buyNowBtn.onclick=async()=>{
    if(!currentUser) return alert("Login first");
    const res=await authFetch(`${API_BASE}/payments/paystack/init/`,{
        method:"POST",
        body:JSON.stringify({
            email: currentEmail,
            amount: selectedListing.price
        })
    });
    const data=await res.json();
    if(data.authorization_url){
        window.location.href=data.authorization_url;
    } else {
        alert("Payment initiation failed âŒ");
        console.error(data);
    }
};

/* BUTTONS */
loginBtn.onclick=()=>location.href="login.html";
registerBtn.onclick=()=>location.href="register.html";
logoutBtn.onclick=()=>{localStorage.clear();location.href="login.html";};

loadProfile();
</script>
</body>
</html>

